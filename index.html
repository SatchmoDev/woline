<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Three Woreda Maps</title>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="token.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css"
      rel="stylesheet"
    />

    <style>
      /* Layout and Structure */
      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      #maps-container {
        display: flex;
        flex: 1;
      }

      .map-wrapper {
        flex: 1;
        position: relative;
      }

      .map {
        width: 100%;
        height: 100%;
      }

      .map-wrapper:nth-child(2) {
        border-left: 2px solid black;
        border-right: 2px solid black;
      }

      /* Tally Card Styles */
      .tally-card {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 0.95);
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        font-family: Arial, sans-serif;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 100;
        min-width: 280px;
        opacity: 0;
        transition: opacity 1s ease-in-out;
      }

      .tally-card.visible {
        opacity: 1;
      }

      .tally-card h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      }

      .tally-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .tally-item:last-child {
        margin-bottom: 0;
      }

      .event-type {
        color: #555;
        font-weight: normal;
        font-size: 18px;
      }

      .count {
        font-weight: bold;
        color: #333;
        min-width: 20px;
        font-size: 18px;
        text-align: right;
      }

      /* Timeline Styles */
      #timeline-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ffffff;
        width: 112%;
        max-width: 1120px;
        z-index: 1000;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      #timeline-bar {
        height: 16px;
        background-color: #e4e4e4;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      #timeline-progress {
        height: 100%;
        width: 0%;
        background-color: #1f9c1f;
        transition: width 35s linear;
      }

      #timeline-dates {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-family: Arial, sans-serif;
        font-size: 20px;
        color: #333;
      }

      #current-date {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        padding: 0 4px;
      }

      /* Watermark */
      .seal-watermark {
        position: fixed;
        top: 30px;
        left: 30px;
        z-index: 10;
        width: 120px;
        height: auto;
      }
    </style>
  </head>

  <body>
    <img src="data/seal.png" alt="ALT Space" class="seal-watermark" />

    <div id="timeline-container">
      <div id="timeline-bar">
        <div id="timeline-progress"></div>
      </div>
      <div id="timeline-dates">
        <span id="start-date"></span>
        <span id="current-date"></span>
        <span id="end-date"></span>
      </div>
    </div>

    <div id="maps-container">
      <div class="map-wrapper">
        <div id="map1" class="map"></div>
        <div id="tally1" class="tally-card">
          <!-- <h3>Bishoftu Incidents</h3> -->
          <div class="tally-item">
            <span class="event-type">Intertribal Conflict:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Kidnapping:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Disaster:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Political Tension:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Protests:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Military Action:</span>
            <span class="count">0</span>
          </div>
        </div>
      </div>
      <div class="map-wrapper">
        <div id="map2" class="map"></div>
        <div id="tally2" class="tally-card">
          <!-- <h3>Jimma Incidents</h3> -->
          <div class="tally-item">
            <span class="event-type">Intertribal Conflict:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Kidnapping:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Disaster:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Political Tension:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Protests:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Military Action:</span>
            <span class="count">0</span>
          </div>
        </div>
      </div>
      <div class="map-wrapper">
        <div id="map3" class="map"></div>
        <div id="tally3" class="tally-card">
          <!-- <h3>Debre Tabor Incidents</h3> -->
          <div class="tally-item">
            <span class="event-type">Intertribal Conflict:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Kidnapping:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Disaster:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Political Tension:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Protests:</span>
            <span class="count">0</span>
          </div>
          <div class="tally-item">
            <span class="event-type">Military Action:</span>
            <span class="count">0</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===================================================================
      // CONSTANTS AND CONFIGURATION
      // ===================================================================

      // MAPBOX_ACCESS_TOKEN loaded from token.js
      const MAPBOX_STYLE = "mapbox://styles/studavid/cmcmsfdcd00el01s03dabfyoy"

      const DATA_URLS = {
        woredas: "/data/woreda.geojson",
        events: "/data/fake.geojson",
      }

      const WOREDA_CONFIGS = [
        {
          id: "map1",
          woredaId: 223294,
          woredaName: "Bishoftu",
          center: [38.984, 8.747],
        },
        {
          id: "map2",
          woredaId: 223235,
          woredaName: "Jimma",
          center: [36.846, 7.685],
        },
        {
          id: "map3",
          woredaId: 222955,
          woredaName: "Debre Tabor",
          center: [38.007, 11.862],
        },
      ]

      const WOREDA_COORDINATES = {
        Bishoftu: [38.984, 8.747],
        Jimma: [36.846, 7.685],
        "Debre Tabor": [38.007, 11.862],
      }

      const TIMING_CONSTANTS = {
        timelineAnimationDuration: 35000, // 35 seconds
        colorUpdateThrottle: 200, // 200ms
        flashDuration: 200, // 200ms
        redPeriodDays: 30,
        totalRedYellowPeriodDays: 50, // 30 red + 20 yellow
        yellowOnlyPeriodDays: 20,
        coordinateMatchTolerance: 0.001,
      }

      const COLORS = {
        red: "#ff0000",
        yellow: "#ffff00",
        white: "#ffffff",
        transparent: "rgba(0,0,0,0)",
      }

      const ADDIS_ABABA_CENTER = [38.7666, 9.0333]

      // ===================================================================
      // GLOBAL STATE VARIABLES
      // ===================================================================

      let eventData = []
      let mapInstances = []
      let minDate = null
      let maxDate = null
      let lastUpdateTime = 0
      let mapsLoaded = 0
      let mapsTransitioned = 0

      const woredaState = {
        Bishoftu: {
          lastColor: COLORS.transparent,
          lastEventDate: null,
          isFlashing: false,
        },
        Jimma: {
          lastColor: COLORS.transparent,
          lastEventDate: null,
          isFlashing: false,
        },
        "Debre Tabor": {
          lastColor: COLORS.transparent,
          lastEventDate: null,
          isFlashing: false,
        },
      }

      const tallyCounts = {
        Bishoftu: {
          "Intertribal Conflict": 0,
          Kidnapping: 0,
          Disaster: 0,
          "Political Tension": 0,
          Protests: 0,
          "Military Action": 0,
        },
        Jimma: {
          "Intertribal Conflict": 0,
          Kidnapping: 0,
          Disaster: 0,
          "Political Tension": 0,
          Protests: 0,
          "Military Action": 0,
        },
        "Debre Tabor": {
          "Intertribal Conflict": 0,
          Kidnapping: 0,
          Disaster: 0,
          "Political Tension": 0,
          Protests: 0,
          "Military Action": 0,
        },
      }

      // ===================================================================
      // UTILITY FUNCTIONS
      // ===================================================================

      function formatDate(date) {
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        })
      }

      function getWoredaFromCoordinates(longitude, latitude) {
        for (const [woredaName, [woredaLng, woredaLat]] of Object.entries(
          WOREDA_COORDINATES
        )) {
          if (
            Math.abs(longitude - woredaLng) <
              TIMING_CONSTANTS.coordinateMatchTolerance &&
            Math.abs(latitude - woredaLat) <
              TIMING_CONSTANTS.coordinateMatchTolerance
          ) {
            return woredaName
          }
        }
        return null
      }

      function calculateDaysDifference(fromDate, toDate) {
        return (toDate - fromDate) / (1000 * 60 * 60 * 24)
      }

      function updateTallyCounts(currentDate) {
        // Reset all tally counts
        Object.keys(tallyCounts).forEach((woredaName) => {
          Object.keys(tallyCounts[woredaName]).forEach((eventType) => {
            tallyCounts[woredaName][eventType] = 0
          })
        })

        // Count events up to current date
        eventData.forEach((event) => {
          if (event.date <= currentDate) {
            const woredaName = getWoredaFromCoordinates(
              event.longitude,
              event.latitude
            )
            if (
              woredaName &&
              tallyCounts[woredaName] &&
              tallyCounts[woredaName][event.eventType] !== undefined
            ) {
              tallyCounts[woredaName][event.eventType]++
            }
          }
        })
      }

      function updateTallyDisplay() {
        WOREDA_CONFIGS.forEach((config, index) => {
          const tallyElement = document.getElementById(`tally${index + 1}`)
          if (tallyElement) {
            const countElements = tallyElement.querySelectorAll(".count")
            const eventTypes = [
              "Intertribal Conflict",
              "Kidnapping",
              "Disaster",
              "Political Tension",
              "Protests",
              "Military Action",
            ]

            eventTypes.forEach((eventType, typeIndex) => {
              if (countElements[typeIndex]) {
                countElements[typeIndex].textContent =
                  tallyCounts[config.woredaName][eventType]
              }
            })
          }
        })
      }

      // ===================================================================
      // DATA LOADING AND PROCESSING
      // ===================================================================

      async function loadEventData() {
        try {
          const response = await fetch(DATA_URLS.events)
          const geoJsonData = await response.json()

          eventData = []
          minDate = null
          maxDate = null

          geoJsonData.features.forEach((feature) => {
            const properties = feature.properties
            const coordinates = feature.geometry.coordinates
            const date = new Date(properties.event_date)

            if (!isNaN(date)) {
              eventData.push({
                date: date,
                longitude: coordinates[0],
                latitude: coordinates[1],
                color: properties.color,
                eventId: properties.event_id,
                eventType: properties.event_type,
                fatalities: properties.fatalities,
              })

              if (!minDate || date < minDate) minDate = date
              if (!maxDate || date > maxDate) maxDate = date
            }
          })

          return { minDate, maxDate }
        } catch (error) {
          console.error("Error loading event data:", error)
          return { minDate: new Date(), maxDate: new Date() }
        }
      }

      // ===================================================================
      // COLOR STATE MANAGEMENT
      // ===================================================================

      function calculateWoredaColorState(woredaName, currentDate) {
        const woredaEvents = eventData.filter((event) => {
          const eventWoreda = getWoredaFromCoordinates(
            event.longitude,
            event.latitude
          )
          return eventWoreda === woredaName && event.date <= currentDate
        })

        if (woredaEvents.length === 0) {
          return { color: COLORS.transparent, mostRecentEventDate: null }
        }

        let mostRecentRed = null
        let mostRecentYellow = null

        woredaEvents.forEach((event) => {
          if (event.color === "red") {
            if (!mostRecentRed || event.date > mostRecentRed.date) {
              mostRecentRed = event
            }
          } else if (event.color === "yellow") {
            if (!mostRecentYellow || event.date > mostRecentYellow.date) {
              mostRecentYellow = event
            }
          }
        })

        const daysSinceRed = mostRecentRed
          ? calculateDaysDifference(mostRecentRed.date, currentDate)
          : null
        const daysSinceYellow = mostRecentYellow
          ? calculateDaysDifference(mostRecentYellow.date, currentDate)
          : null

        if (mostRecentRed && daysSinceRed <= TIMING_CONSTANTS.redPeriodDays) {
          return { color: COLORS.red, mostRecentEventDate: mostRecentRed.date }
        } else if (
          mostRecentRed &&
          daysSinceRed <= TIMING_CONSTANTS.totalRedYellowPeriodDays
        ) {
          return {
            color: COLORS.yellow,
            mostRecentEventDate: mostRecentRed.date,
          }
        } else if (
          mostRecentYellow &&
          daysSinceYellow <= TIMING_CONSTANTS.yellowOnlyPeriodDays
        ) {
          return {
            color: COLORS.yellow,
            mostRecentEventDate: mostRecentYellow.date,
          }
        } else {
          return { color: COLORS.transparent, mostRecentEventDate: null }
        }
      }

      // ===================================================================
      // VISUAL EFFECTS
      // ===================================================================

      function triggerFlash(woredaName, color) {
        const mapInfo = mapInstances.find((m) => m.woredaName === woredaName)
        if (!mapInfo || woredaState[woredaName].isFlashing) return

        const map = mapInfo.map
        woredaState[woredaName].isFlashing = true

        if (map.getLayer("woreda-fill") && map.isStyleLoaded()) {
          try {
            map.setPaintProperty("woreda-fill", "fill-color", COLORS.white)

            setTimeout(() => {
              map.setPaintProperty("woreda-fill", "fill-color", color)
              woredaState[woredaName].isFlashing = false
            }, TIMING_CONSTANTS.flashDuration)
          } catch (error) {
            console.error(
              `Failed to create flash effect for ${woredaName}:`,
              error
            )
            woredaState[woredaName].isFlashing = false
          }
        }
      }

      function updateWoredaColors(currentDate) {
        if (mapsTransitioned < WOREDA_CONFIGS.length) return

        const woredaResults = {}
        WOREDA_CONFIGS.forEach((config) => {
          woredaResults[config.woredaName] = calculateWoredaColorState(
            config.woredaName,
            currentDate
          )
        })

        // Check for timer resets and trigger flash effects
        Object.keys(woredaResults).forEach((woredaName) => {
          const result = woredaResults[woredaName]
          const currentColor = result.color
          const currentEventDate = result.mostRecentEventDate
          const previousState = woredaState[woredaName]

          if (
            currentColor !== COLORS.transparent &&
            currentColor === previousState.lastColor &&
            currentEventDate &&
            previousState.lastEventDate &&
            currentEventDate > previousState.lastEventDate
          ) {
            triggerFlash(woredaName, currentColor)
          }

          woredaState[woredaName].lastColor = currentColor
          woredaState[woredaName].lastEventDate = currentEventDate
        })

        // Update map colors
        mapInstances.forEach((mapInfo) => {
          const woredaName = mapInfo.woredaName
          const color = woredaResults[woredaName].color

          if (woredaState[woredaName].isFlashing) return

          if (
            mapInfo.map.getLayer("woreda-fill") &&
            mapInfo.map.isStyleLoaded()
          ) {
            try {
              mapInfo.map.setPaintProperty("woreda-fill", "fill-color", color)
            } catch (error) {
              console.error(
                `Failed to set paint property for ${woredaName}:`,
                error
              )
            }
          }
        })
      }

      // ===================================================================
      // MAP TRANSITIONS
      // ===================================================================

      function flyToWoredas() {
        setTimeout(() => {
          mapInstances.forEach((mapInfo, index) => {
            const config = WOREDA_CONFIGS[index]

            // Fetch woreda data and fly to bounds
            fetch(DATA_URLS.woredas)
              .then((res) => res.json())
              .then((data) => {
                const features = data.features.filter(
                  (f) => f.properties.id === config.woredaId
                )
                if (features.length > 0) {
                  const bbox = turf.bbox(features[0])
                  mapInfo.map.fitBounds(bbox, {
                    padding: 20,
                    duration: 4000, // 4 second transition
                    easing: (t) => {
                      // Ease-in-out cubic for smooth, gradual movement
                      return t < 0.5
                        ? 4 * t * t * t
                        : 1 - Math.pow(-2 * t + 2, 3) / 2
                    },
                  })

                  // Listen for transition completion
                  mapInfo.map.once("moveend", () => {
                    mapsTransitioned++

                    // Fade in the tally card for this map
                    const tallyCard = document.getElementById(
                      `tally${index + 1}`
                    )
                    if (tallyCard) {
                      tallyCard.classList.add("visible")
                    }

                    if (mapsTransitioned === WOREDA_CONFIGS.length) {
                      startTimeline()
                    }
                  })
                }
              })
          })
        }, 3000) // 3 second delay
      }

      // ===================================================================
      // TIMELINE SYSTEM
      // ===================================================================

      async function initTimeline() {
        try {
          const dateRange = await loadEventData()
          minDate = dateRange.minDate
          maxDate = dateRange.maxDate

          document.getElementById("start-date").textContent =
            formatDate(minDate)
          document.getElementById("end-date").textContent = formatDate(maxDate)
          document.getElementById("current-date").textContent =
            formatDate(minDate)
        } catch (error) {
          console.error("Error loading timeline data:", error)
        }
      }

      function startTimeline() {
        setTimeout(() => {
          const progressBar = document.getElementById("timeline-progress")
          progressBar.style.width = "100%"

          const startTime = Date.now()
          const totalDays = calculateDaysDifference(minDate, maxDate)

          const updateCurrentDate = () => {
            const elapsed = Date.now() - startTime
            const progress = Math.min(
              elapsed / TIMING_CONSTANTS.timelineAnimationDuration,
              1
            )
            const currentDays = totalDays * progress
            const currentDate = new Date(
              minDate.getTime() + currentDays * 24 * 60 * 60 * 1000
            )

            document.getElementById("current-date").textContent =
              formatDate(currentDate)

            const now = Date.now()
            if (now - lastUpdateTime >= TIMING_CONSTANTS.colorUpdateThrottle) {
              updateWoredaColors(currentDate)
              updateTallyCounts(currentDate)
              updateTallyDisplay()
              lastUpdateTime = now
            }

            if (progress < 1) {
              requestAnimationFrame(updateCurrentDate)
            }
          }

          requestAnimationFrame(updateCurrentDate)
        }, 500)
      }

      // ===================================================================
      // MAP INITIALIZATION
      // ===================================================================

      function initializeMaps() {
        mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN

        WOREDA_CONFIGS.forEach((config) => {
          const map = new mapboxgl.Map({
            container: config.id,
            style: MAPBOX_STYLE,
            center: ADDIS_ABABA_CENTER,
            zoom: 8,
          })

          mapInstances.push({
            map: map,
            woredaName: config.woredaName,
          })

          map.on("load", () => {
            map.addSource("woredas", {
              type: "geojson",
              data: DATA_URLS.woredas,
            })

            map.addLayer({
              id: "woreda-fill",
              type: "fill",
              source: "woredas",
              paint: {
                "fill-color": COLORS.transparent,
                "fill-opacity": 0.5,
              },
              filter: ["==", ["get", "id"], config.woredaId],
            })

            mapsLoaded++
            if (mapsLoaded === WOREDA_CONFIGS.length) {
              flyToWoredas()
            }
          })
        })
      }

      // ===================================================================
      // APPLICATION INITIALIZATION
      // ===================================================================

      window.addEventListener("load", () => {
        initializeMaps()
        initTimeline()
      })
    </script>
  </body>
</html>
